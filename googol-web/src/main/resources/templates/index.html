<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Googol</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .googol-logo { font-size: 3.5rem; font-weight: bold; color: #4285f4; letter-spacing: -2px; }
        .logo-o1 { color: #ea4335; } .logo-o2 { color: #fbbc05; }
        .logo-g2 { color: #4285f4; } .logo-l { color: #34a853; }
        
        .main-container { max-width: 900px; margin-top: 30px; }
        .search-card { border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .stats-container { margin-top: 40px; }
        .stat-card { 
            border: none; 
            border-radius: 15px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); 
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-header { font-size: 0.9rem; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; color: #6c757d; }
        
        .barrel-item { font-size: 0.9rem; border-left: 4px solid #34a853; background: #f8f9fa; margin-bottom: 10px; padding: 12px; border-radius: 4px; }
        .barrel-offline { border-left-color: #dc3545; }
    </style>
</head>
<body class="bg-light pb-5">

<div class="container main-container text-center">
    
    <div class="mb-5">
        <h1 class="googol-logo mb-4">G<span class="logo-o1">o</span><span class="logo-o2">o</span><span class="logo-g2">g</span><span class="logo-l">o</span>l</h1>
        
        <div th:if="${message}" class="alert" th:classappend="${alertClass}" role="alert">
            <span th:text="${message}"></span>
        </div>

        <div class="card search-card p-4 bg-white">
            <form action="/search" method="get">
                <div class="input-group input-group-lg">
                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                    <input type="text" name="query" class="form-control border-start-0" placeholder="O que procura hoje?" required>
                    <button class="btn btn-primary px-4" type="submit">Pesquisar</button>
                </div>
            </form>
            
            <div class="d-flex justify-content-center gap-3 mt-3">
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#indexTools">
                    <i class="fas fa-plus-circle me-1"></i> Ferramentas de Indexação
                </button>
            </div>

            <div class="collapse mt-3" id="indexTools">
                <div class="card card-body bg-light border-0">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <form action="/index" method="post" class="d-flex gap-2">
                                <input type="url" name="url" class="form-control form-control-sm" placeholder="https://site.com" required>
                                <button type="submit" class="btn btn-sm btn-dark">Indexar URL</button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <form action="/api/hackernews" method="post" class="d-flex gap-2">
                                <input type="text" name="query" class="form-control form-control-sm" placeholder="Tópico Hacker News" required>
                                <button type="submit" class="btn btn-sm btn-warning fw-bold">HN Index</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="stats-container text-start">
        <div class="d-flex align-items-center mb-3">
            <h5 class="m-0"><i class="fas fa-chart-line text-primary me-2"></i>Estatísticas do Sistema</h5>
            <span class="badge bg-success ms-2 animate-pulse">Ao Vivo</span>
        </div>

        <div class="row g-4">
            <div class="col-md-7">
                <div class="card stat-card p-3 h-100">
                    <div class="stat-header mb-3">Tendências de Pesquisa</div>
                    <div style="position: relative; height: 250px;">
                        <canvas id="topSearchesChart"></canvas>
                    </div>
                    <div id="noDataMsg" class="text-center text-muted mt-5" style="display:none;">
                        Sem dados de pesquisa ainda.
                    </div>
                </div>
            </div>

            <div class="col-md-5">
                <div class="card stat-card p-3 h-100">
                    <div class="stat-header mb-3">Storage Barrels Ativos</div>
                    <div id="barrels-list" class="overflow-auto" style="max-height: 250px;">
                        <small class="text-muted">A aguardar conexão...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- Configuração do Gráfico (Chart.js) ---
    const ctx = document.getElementById('topSearchesChart').getContext('2d');
    const searchChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Nº de Pesquisas',
                data: [],
                backgroundColor: 'rgba(66, 133, 244, 0.7)',
                borderColor: 'rgba(66, 133, 244, 1)',
                borderWidth: 1,
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });

    // --- Lógica WebSocket e Parsing ---
    var stompClient = null;

    function connect() {
        var socket = new SockJS('/googol-websocket');
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // Desativa logs na consola

        stompClient.connect({}, function (frame) {
            console.log('WS Conectado');
            stompClient.subscribe('/topic/stats', function (message) {
                parseAndUpdateStats(message.body);
            });
        });
    }

    // Função que "lê" o texto cru da Gateway e atualiza o UI
    function parseAndUpdateStats(text) {
        // 1. Extrair Top Pesquisas
        const topSearchesRegex = /'(.+?)': (\d+) pesquisas/g;
        let match;
        const labels = [];
        const data = [];
        
        while ((match = topSearchesRegex.exec(text)) !== null) {
            labels.push(match[1]); // O termo
            data.push(parseInt(match[2])); // O número
        }

        // Atualizar Gráfico
        searchChart.data.labels = labels;
        searchChart.data.datasets[0].data = data;
        searchChart.update();
        
        document.getElementById('noDataMsg').style.display = labels.length === 0 ? 'block' : 'none';

        // 2. Extrair Info dos Barrels
        const barrelsSection = text.split('-- Barrels Ativos --')[1]?.split('--')[0] || "";
        const barrelsDiv = document.getElementById('barrels-list');
        
        if (barrelsSection.trim()) {
            const lines = barrelsSection.trim().split('\n');
            let html = "";
            lines.forEach(line => {
                if(line.trim()) {
                    // Verifica se é erro/offline
                    const isOffline = line.includes("Inacessível") || line.includes("Erro");
                    const icon = isOffline ? '<i class="fas fa-exclamation-triangle text-danger"></i>' : '<i class="fas fa-server text-success"></i>';
                    const cssClass = isOffline ? 'barrel-offline' : '';
                    
                    html += `<div class="barrel-item ${cssClass}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span>${icon} <strong>${line.split(']')[0].replace('[','')}</strong></span>
                                    ${!isOffline ? '<span class="badge bg-success rounded-pill" style="font-size: 0.6rem;">ONLINE</span>' : '<span class="badge bg-danger rounded-pill" style="font-size: 0.6rem;">OFFLINE</span>'}
                                </div>
                                <div class="text-muted text-truncate">${line.split(']')[1] || ''}</div>
                             </div>`;
                }
            });
            barrelsDiv.innerHTML = html;
        }
    }

    connect();
</script>

</body>
</html>