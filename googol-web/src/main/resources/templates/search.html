<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="'Googol - ' + ${query}">Resultados</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .result-url { color: #202124; font-size: 0.875rem; }
        .result-title { color: #1a0dab; text-decoration: none; font-size: 1.25rem; }
        .result-title:hover { text-decoration: underline; }
        .result-snippet { color: #4d5156; font-size: 0.9rem; }
        .ai-box { background: #f0f7ff; border: 1px solid #cce5ff; border-radius: 12px; }
        .ai-icon { font-size: 1.2rem; margin-right: 8px; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom p-3 sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold text-primary" href="/">Googol</a>
        <form action="/search" method="get" class="d-flex w-50">
            <input class="form-control me-2 rounded-pill" type="search" name="query" th:value="${query}">
            <button class="btn btn-outline-primary rounded-pill" type="submit"><i class="fas fa-search"></i></button>
        </form>
    </div>
</nav>

<div class="container mt-4 mb-5">
    
    <div class="ai-box p-3 mb-4" th:if="${totalResults > 0}">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="m-0 text-primary"><span class="ai-icon">✨</span>Resumo Inteligente</h6>
            <button id="btn-generate-ai" class="btn btn-sm btn-primary rounded-pill" onclick="fetchSummary()">
                Gerar Resumo
            </button>
        </div>
        <div id="ai-loading" class="text-center mt-3 d-none">
            <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
            <span class="ms-2 small text-muted">A ler os resultados e a gerar resumo...</span>
        </div>
        <div id="ai-content" class="mt-3 text-dark small d-none" style="white-space: pre-line; line-height: 1.6;"></div>
    </div>

    <p class="text-muted small">Cerca de <span th:text="${totalResults}">0</span> resultados.</p>

    <div th:each="result : ${results}" class="mb-4 bg-white p-3 rounded shadow-sm">
        <div class="result-url" th:text="${result.url}">url</div>
        <a th:href="${result.url}" class="result-title" th:text="${result.title}">Título</a>
        <p class="result-snippet mt-1 mb-0">
            <span th:text="${result.citation}">Excerto...</span>
        </p>
        
        <div class="mt-2 d-flex justify-content-between align-items-center border-top pt-2">
            <span class="badge bg-light text-dark border">Relevância: <span th:text="${result.relevance}">0</span></span>
            
            <a th:href="@{/links(url=${result.url})}" class="btn btn-sm btn-outline-secondary" style="font-size: 0.8rem;">
                <i class="fas fa-project-diagram me-1"></i> Ver Backlinks
            </a>
        </div>
    </div>
    
    <div th:if="${#lists.isEmpty(results)}" class="alert alert-warning">
        Nenhum resultado encontrado para "<strong><span th:text="${query}"></span></strong>".
    </div>

    <nav th:if="${totalPages > 1}" class="mt-5">
        <ul class="pagination justify-content-center">
            <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
                <a class="page-link" th:href="@{/search(query=${query}, page=${currentPage - 1})}">Anterior</a>
            </li>
            <li class="page-item" th:each="i : ${#numbers.sequence(1, totalPages)}" 
                th:classappend="${currentPage == i} ? 'active'">
                <a class="page-link" th:href="@{/search(query=${query}, page=${i})}" th:text="${i}">1</a>
            </li>
            <li class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled'">
                <a class="page-link" th:href="@{/search(query=${query}, page=${currentPage + 1})}">Próximo</a>
            </li>
        </ul>
    </nav>
</div>

<script th:inline="javascript">
    function fetchSummary() {
        const query = /*[[${query}]]*/ '';
        const btn = document.getElementById('btn-generate-ai');
        const loading = document.getElementById('ai-loading');
        const content = document.getElementById('ai-content');

        btn.disabled = true;
        btn.classList.add('d-none');
        loading.classList.remove('d-none');

        fetch('/api/summary?query=' + encodeURIComponent(query))
            .then(response => response.json())
            .then(data => {
                loading.classList.add('d-none');
                content.classList.remove('d-none');
                content.innerText = data.summary;
            })
            .catch(error => {
                console.error('Erro:', error);
                loading.classList.add('d-none');
                content.classList.remove('d-none');
                content.innerHTML = '<span class="text-danger">Falha ao gerar resumo.</span>';
                btn.classList.remove('d-none');
                btn.disabled = false;
            });
    }
</script>

</body>
</html>